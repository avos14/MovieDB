<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>MoviesDB</title>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
            crossorigin="anonymous">
    </script>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" />
    <link href="StyleSheet.css" rel="stylesheet" />
    <script src="../Scripts/AjaxCalls.js"></script>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-database.js"></script>

    <script src="../Scripts/config.js"></script>
    <script>

        // https://api.themoviedb.org/3/search/tv?api_key=5e38c192471c6bdcbbc7c8d5d5d68972&language=en-US&page=1&include_adult=false&query=Grey%27s%20Anatomy

        $(document).ready(function () {
            $("#getTV").click(getTV);
            key = "5e38c192471c6bdcbbc7c8d5d5d68972";
            url = "https://api.themoviedb.org/";
            imagePath = "https://image.tmdb.org/t/p/w500/";
            //https://api.themoviedb.org/3/tv/1416/season/0/episode/64467?api_key=5e38c192471c6bdcbbc7c8d5d5d68972&language=en-US


            document.getElementById("birthYear").innerHTML += "<option disabled selected> Select Year of Birth </option>";
            for (let i = 1970; i <= 2000; i++) {
                document.getElementById("birthYear").innerHTML += "<option value='" + i + "'>" + i + "</option>";
            }

            $("#password").on("blur", checkPassword);

            $("#lForm").submit(submitLogin);
            $("#rForm").submit(submitUser);
            if (localStorage.user != null) {
                resumeUser()
            }
            else getPopularSeries();

        });

        function getTV() {
            name = $("#tvShowName").val();
            if (name == "")
                alert("Please enter a show")
            else {
                let method = "3/search/tv?";
                let api_key = "api_key=" + key;
                let moreParams = "&language=en-US&page=1&include_adult=false&";
                let query = "query=" + encodeURIComponent(name);
                let apiCall = url + method + api_key + moreParams + query;
                ajaxCall("GET", apiCall, "", getTVSuccessCB, getTVErrorCB);
            }
        }
        function getTVSuccessCB(tv) {
            console.log("ajax response:");
            console.log(tv);
            tv = tv.results[0];
            tvId = tv.id;
            let poster = imagePath + tv.poster_path;
            let str = "";
            str += "<div class='TvTitle'>" + tv.name + " (" + tv.first_air_date.slice(0, 4) + ")</div>";
            str += "<div class='row' id='seriesRowPH'>";
            str += "<div class='col-3' id='leftDiv'>";
            str += "<img src='" + poster + "'/>";
            str += "</div>";
            str += "<div class='col-9' id='rightDiv'>";
            str += "<p>" + tv.overview + "</p>";
            str += "<div id='genrePH'><span class='bold'> Genres:</span> </div>";
            str += "</div>";
            $("#seriesPH").html(str);
            $("#seriesPH").css('display', 'block')
            $("#episodes1").html("");
            let method = "3/tv/";
            let api_key = "api_key=" + key
            //      let apiCall = url + method + tvId + "/season/" + 0 + "?" + api_key
            let apiCall = url + method + tvId + "?" + api_key

            ajaxCall("GET", apiCall, "", getSeriesSuccessCB, getSeasonErrorCB)

            //Get cast info
            let apiCall_2 = url + method + tvId + "/credits?" + api_key
            ajaxCall("GET", apiCall_2, "", getCreditsSuccessCB, getCreditsErrorCB);
            let apiCall_3 = url + method + tvId + "/videos?" + api_key
            ajaxCall("GET", apiCall_3, "", getTrailerSuccessCB, getTrailerErrorCB);
        }
        function getTrailerSuccessCB(trailer) {
            console.log(trailer);
            if (trailer.results.length != 0) {
                if (trailer.results[0].type == "Trailer") {
                    let trailer_path = trailer.results[0].key;
                    let str = "<h3 class='title'>Series Trailer</h3>"
                    str += "<iframe width='420' height='345' src='https://www.youtube.com/embed/" + trailer_path + "'></iframe >";
                    $("#trailerPH").html(str);
                }
                else $("#trailerPH").html("");
            }
            else $("#trailerPH").html("");
        }
            function getTrailerErrorCB(err) {
            console.log(err);
        }

        function getSeriesSuccessCB(series) {
            sTmp = series;
            let str = "";
            console.log("getSeriesSuccessCB response:");
            console.log(series);
            seasons = series.seasons;
            console.log("Season count = " + seasons.length);
            $("#seasons").html("<p class='title'>Select a Season to view the coresponding episodes</p>");
            str += "<div class='container'><div class='row' id='seasonsContainer'>"

            if (seasons[0].name == "Specials")
                i = 1;
            else i = 0;
            
            if (seasons.length == 1) {
                str += "<div class='card' id='season_" + 1 + "' onclick='select_season(this.id)'>";
                str += "<img src='" + imagePath + seasons[0].poster_path + "'>";
                str += "<div class='seasonInfo'><h4><b>" + seasons[0].name + "</b></h4><p>Episodes: " + seasons[0].episode_count + "</div>";

                str += "</div>";
            }
            else {
                for (; i < seasons.length; i++) {
                    if (seasons[i].poster_path != null) {
                        str += "<div class='card' id='season_" + (i+1) + "' onclick='select_season(this.id)'>";
                        str += "<img src='" + imagePath + seasons[i].poster_path + "'>";
                        str += "<div class='seasonInfo'><h4><b>" + seasons[i].name + "</b></h4><p>Episodes: " + seasons[i].episode_count + "</div>";

                        str += "</div>";
                    }
                    //str += "</div></div>";
                }
            }
            $("#seasons1").html(str);

            //render to overview box
            let len = series.genres.length
            for (i = 0; i < len; i++) {
                $("#genrePH").append(series.genres[i].name);
                if (i + 1 != len)
                    $("#genrePH").append(", ");
            }
            $("#rightDiv").append("<div><span class=bold>Last Air Date:</span> " + fixDate(series.last_air_date))
            if (series.next_episode_to_air != null) {
                $("#rightDiv").append("<div><span class=bold>Next Episode Air Date:</span> " + fixDate(series.next_episode_to_air.air_date))
            }
            $("#rightDiv").append("<div id='seriesRating'><span class='bold'>Users Rating:</span> </div>")
            getRating(series.id);
            renderRating();

        }
        function renderRating() {
            let str = "";
            str += "<div><label for='userRating'><span class=bold>Rate this Show: </span></label>"
            str += "<select name='userRating' id='userRating'>"
            str += "<option disabled selected value>***Rating***</option>"
            for (let i = 1; i < 6; i++) {
                str += "<option class='optionRating' value='" + i + "'>" + i + "</option>";
            }
            str += "</select></div>";
            str += "<input type='button' id='rate' onclick='rateSeries()' value='Rate!'>"
            $("#rightDiv").append(str);
        }
        function rateSeries() {
            if (localStorage.user == null)
                alert("You have to log in before rating a show")
            else {
                let rating = $("#userRating").val();
                if (rating == null)
                    alert("Please select a rating from the dropdown list!");
                else {
                    let user = JSON.parse(localStorage.user);
                    let r = {
                        UserId: user.UserId,
                        SeriesId: sTmp.id,
                        Rate: rating
                    }
                    let ratedSeries = [];
                    ratedSeries = JSON.parse(localStorage.userRatedSeries)
                    //check if user already rated the specified series
                    if (!(ratedSeries.includes(r.SeriesId))) {
                        //user didn't rate the specified series
                        let api = "../api/Rating";
                        ajaxCall("POST", api, JSON.stringify(r), postRatingSuccessCB, postRatingErrorCB)
                        ratedSeries.push(r.SeriesId);
                        localStorage.userRatedSeries = JSON.stringify(ratedSeries);
                    }
                    else {
                        let api = "../api/Rating/UpdateUserRating";
                        ajaxCall("POST", api, JSON.stringify(r), putUserRatingSuccessCB, putUserRatingErrorCB);
                    }

                }
            }
        }
        function putUserRatingSuccessCB() {
            alert("You have successfuly updated your Series Rating!");
            getRating(sTmp.id);
        }
        function putUserRatingErrorCB(err) {
            console.log(err);
        }
        function postRatingSuccessCB(postRating) {
            alert("Thank you for your rating");
            getRating(sTmp.id);
        }
        function postRatingErrorCB(err) {
            console.log(err);
        }
        function getUserRating(userId) {
            let api = "../api/Rating/getUserRating?userId=" + userId;
            ajaxCall("GET", api, "", getUserRatingSuccessCB, getUserRatingErrorCB)
        }
        function getUserRatingSuccessCB(rating) {
            console.log(rating)
            localStorage.userRatedSeries = JSON.stringify(rating);
        }
        function getUserRatingErrorCB(err) {
            console.log(err);
        }
        function getRating(seriesId) {
            let api = "../api/Rating?seriesId=" + seriesId;
            ajaxCall("GET", api, "", getRatingSuccessCB, getRatingErrorCB)
        }
        function getRatingSuccessCB(rating) {
            if (rating != 0) {
                $("#seriesRating").html("<span class='bold'>Users Rating:</span> " + rating + "/5")
            }
            else $("#seriesRating").html("<span class='bold'>Users Rating:</span> Series not rated yet! Be the first to give it a rating!")
        }
        function getRatingErrorCB(err) {
            console.log(err);
        }
        function getCreditsSuccessCB(credits) {
            let cast = credits.cast;
            let str = ""
            str += "<div class='TvTitle title'>Cast</div>";
            str += "<div class='row' id='castContainer'>";
            for (let i = 0; i < cast.length; i++) {
                 
                str += "<div class='card castActor' id='" + cast[i].id + "' onclick='showActor(this.id)'>"
                if (cast[i].profile_path == null)
                    str += "<img src='../Pages/images/blank_avatar.png'/>"
                else str += "<img src='" + imagePath + cast[i].profile_path + "'>";

                str += "<div class='castInfo'><b>" + cast[i].name + "</b>" + "<br>" + cast[i].character + "</div>";
                str += "</div>";
                if (i == 9)
                    break;

                
            }
            str += "</div>"
            $("#castPH").html(str);
        }
        function getCreditsErrorCB(err) {
            console.log(err);
        }
        function showActor(id) {
            console.log(id);
            let method = "3/person/";
            let api_key = "api_key=" + key
            let apiCall = url + method + id + "?" + api_key;
            ajaxCall("GET", apiCall, "", getPersonSuccessCB, getPersonErrorCB)
        }
        function getPersonSuccessCB(person) {
            console.log(person)
            let str = "";
            str += "<div class='TvTitle'>" + person.name + "</div>"
            str += "<div class='row'>"
            str += "<div class='col-3' id='leftDiv'>";
            str += "<img src='" + imagePath + person.profile_path + "'/>";
            str += "</div>";
            str += "<div class='col-9' id='rightDiv'>";
            str += "<p>" + person.biography + "</p>";
            str += "<div><span class='bold'>Also known as:</span> " + person.also_known_as[0] + "</div>"
            str += "<div><span class='bold'>Birthday:</span> " + fixDate(person.birthday) + "</div>";
            str += "<div><span class='bold'>Place of Birth:</span> " + person.place_of_birth + "</div>"
            //  str += "<div id='genrePH'><span class='bold'> Genres:</span> </div>";
            str += "</div></div>";
            $("#contentActor").html(str);
            document.getElementById("modalActor").style.display = "block"

        }
        function getPersonErrorCB(err) {
            console.log(err);
        }


        function fixDate(date) {
            let year = date.slice(0, 4);
            let month = date.slice(5, 7);
            let day = date.slice(8,);

            return (day + "/" + month + "/" + year)
        }

        function select_season(season) {
            let i = season.split('_');
            i = i[1];
            let method = "3/tv/";
            let api_key = "api_key=" + key;
            let apiCall = url + method + tvId + "/season/" + i + "?" + api_key
            ajaxCall("GET", apiCall, "", getSeasonSuccessCB, getSeasonErrorCB)
        }

        function getSeasonSuccessCB(season) {
            console.log(season)
            console.log("getSeasonSuccessCB response:");
            episodes = season.episodes;
            console.log(episodes);
            msgArr = {};
            rplyArr = {};
            voteArr = {};
            
            console.log("episode count = " + episodes.length);
            episode_html = "";          
            for (let i = 0; i < episodes.length; i++) {
                episode = episodes[i];
                episode_html += "<div class='episodeDiv'>";
                console.log("digesting episode " + i);
                episode_html += "<b>chapter# " + episode["episode_number"] + ": " + episode["name"] + "</b><br>";
                episode_html += episode["overview"] + "<br>";
                episode_html += "<image src=" + imagePath + episode["still_path"] + "><br>";
                episode_html += "air date: " + episode["air_date"] + "<br>";
                episode_html += "<button id=" + i + "  onclick=\"select_episode(this.id)\"> Add </button>";
                episode_html += "<button id=" + episode.id + " onclick=\"render_discussion(this.id)\"> Discussion </button><br>";
                episode_html += "<label id='" + episode.id + "_ll'>0</label><img class='notClickedLike' id='" + episode.id + "_lb' onclick='likeEpisode(this.id)'/>"; //like button and label
                episode_html += "<label id='" + episode.id + "_dl'>0</label><img class='notClickedDislike' id='" + episode.id + "_db' onclick='dislikeEpisode(this.id)'/>"; //dislike button and label
                episode_html += "</div>";

                createMsgList(episode.id);
                voteArr[episode.id] = [];
                renderLikeDislike(episode.id);
            }
            $("#episodes1").html(episode_html);
        }
        function likeEpisode(id) {
            if (localStorage.user == null)
                alert("Plese log in before liking an episode");
            else {
                let lBtn = "#" + id;
                let episodeId = id.split("_");
                episodeId = episodeId[0];
                let dBtn = "#" + episodeId + "_db";

                if ($(dBtn).attr('class') == 'notClickedDislike') { //not disliked
                    if ($(lBtn).attr('class') == 'notClickedLike') { //not liked
                        $(lBtn).toggleClass('notClickedLike ClickedLike');
                        newVote(episodeId, 1)
                    }
                    else {
                        $(lBtn).toggleClass('notClickedLike ClickedLike'); // already liked
                        updateVote(episodeId, 0);
                        $("#" + episodeId + "_ll").html((parseInt($("#" + episodeId + "_ll").html()) - 1).toString());
                    }
                }
                else {                                              // already disliked
                    $(dBtn).toggleClass('notClickedDislike ClickedDislike');
                    $(lBtn).toggleClass('notClickedLike ClickedLike');
                    updateVote(episodeId, 1);
                    $("#" + episodeId + "_ll").html((parseInt($("#" + episodeId + "_ll").html()) + 1).toString());
                    $("#" + episodeId + "_dl").html((parseInt($("#" + episodeId + "_dl").html()) - 1).toString());
                }
            }
        }
        function dislikeEpisode(id) {
            if (localStorage.user == null)
                alert("Plese log in before disliking an episode");
            else {
                let dBtn = "#" + id;
                let episodeId = id.split("_");
                episodeId = episodeId[0];
                let lBtn = "#" + episodeId + "_lb";
                if ($(lBtn).attr('class') == 'notClickedLike') { //not liked
                    if ($(dBtn).attr('class') == 'notClickedDislike') { //not disliked
                        $(dBtn).toggleClass('notClickedDislike ClickedDislike');
                        newVote(episodeId, -1)
                    }
                    else {
                        $(dBtn).toggleClass('notClickedDislike ClickedDislike'); //already disliked
                        updateVote(episodeId, 0);
                        $("#" + episodeId + "_dl").html((parseInt($("#" + episodeId + "_dl").html()) - 1).toString());

                    }
                }
                else {                                              //already liked
                    $(lBtn).toggleClass('notClickedLike ClickedLike');
                    $(dBtn).toggleClass('notClickedDislike ClickedDislike');
                    updateVote(episodeId, -1);
                    $("#" + episodeId + "_dl").html((parseInt($("#" + episodeId + "_dl").html()) + 1).toString());
                    $("#" + episodeId + "_ll").html((parseInt($("#" + episodeId + "_ll").html()) - 1).toString());
                }
            }
        }
        function newVote(id, vote) {
            let user = JSON.parse(localStorage.user);
            ref = firebase.database().ref("/LikesAndDislikes/" + id + "/" + user.UserId + "/");
            ref.set({ "value": vote, "userId": user.UserId });
        }
        function updateVote(id, vote) {
            let user = JSON.parse(localStorage.user);
            ref = firebase.database().ref("/LikesAndDislikes/" + id + "/" + user.UserId + "/");
            ref.update({ "value": vote, "userId": user.UserId });

            ref.once("value", snapshot => {
                console.log(snapshot.val());
                if (snapshot.val().value == 0) {
                    ref.remove();
                    for (let i = 0; i < voteArr[id].length; i++) {
                        if (voteArr[id][i].user.userId == user.UserId) {
                            voteArr[id].splice(i, 1);
                        }
                    }
                }
                else { 
                    for (let i = 0; i < voteArr[id].length; i++) {
                        if (voteArr[id][i].user.userId == user.UserId)
                            voteArr[id][i].value = vote;
                    }
                }
            });
        }
        function renderLikeDislike(id) {
            let ref = firebase.database().ref("/LikesAndDislikes/" + id);
            ref.on("child_added", snapshot => {
                userVote = {
                    user: snapshot.val()
                }
                voteArr[id].push(userVote)
                setLikeDislike(voteArr[id], id)
            })
        }
        function setLikeDislike(voteArr, id) {
            let likes = 0;
            let dislikes = 0;
            let uId
            if (localStorage.user != null)
                uId = JSON.parse(localStorage.user);
            for (let i = 0; i < voteArr.length; i++) {
                if (voteArr[i].user.value == 1) {
                    likes++;
                    if (localStorage.user != null)
                        if (voteArr[i].user.userId == uId.UserId)
                            $("#" + id + "_lb").attr('class', 'ClickedLike');
                }
                if (voteArr[i].user.value == -1) {
                    dislikes++
                    if (localStorage.user != null)
                        if (voteArr[i].user.userId == uId.UserId)
                            $("#" + id + "_db").attr('class', 'ClickedDislike');
                }
            }
            let ll = "#" + id + "_ll";
            $(ll).html(likes);
            let dl = "#" + id + "_dl";
            $(dl).html(dislikes);
        }
        function createMsgList(id) {
            tmpMsgArr = []
            render_comments(id, tmpMsgArr);
            msgArr[id] = tmpMsgArr;
        }

        function render_discussion(id) {
            str = "";
            str += "<div id='title'>Episode Discussion</div>";
            str += "<div id='commentPH'></div>"
            str += "<label id='ac' for='episodeTA'>Add Comment:</label>";
            str += "<div><textarea id='episodeTA' class='TA' name='episodeTA' rows='4' cols='50'></textarea>"
            str += "<br><button id=" + id + " onclick='submitComment(this.id)'>Submit Comment</button></div>";
            $("#contentDiscussion").html(str);
            $("#modalDiscussion").css("display", "block");

            printMessages(msgArr[id], id);
            createRplyList(id);
        }
        function render_comments(id, tmpMsgArr) {
            let i = 0;
            ref = firebase.database().ref("/discussion/" + id);
            ref.on("child_added", snapshot => {
                msg = {
                    user: snapshot.val().user,
                    content: snapshot.val().msg,
                }
                tmpMsgArr.push(msg)
                printMessage(msg, id, i++);
            })

        }
        function submitComment(id) {
            if (localStorage.user == null)
                alert("Please log in before posting a comment")
            else {
                msg = $("#episodeTA").val();
                if (msg == "")
                    alert("Please enter a comment")
                else {
                    ref = firebase.database().ref("/discussion/" + id);
                    user = JSON.parse(localStorage.user);
                    ref.push().set({ "msg": msg, "user": user.Fname });
                }
            }
        }
        function printMessage(msg, id, i) {
            let msgId = "" + id + "_" + (i + 1);
            str = "<div id='" + msgId + "'>"
            str += "<div class='pComment container'><div class='row'>"
            str += "<div class='col-1'>" + (i + 1) + ".</div>";
            str += "<div class='col-10'><div class='fromUser'>User: " + msg.user + "</div><div class='message'> Message: " + msg.content + "</div></div>"
            str += "<div class='col-1'><button class='rplyButton' value='" + msgId + "'onclick='showTA(value)'>Reply</button></div>";
            str += "</div></div>";
            str += "<div class='replyTA' id='" + msgId + "_DIV'><textarea id='" + msgId + "_TA' class='TA' name='replyTA' rows='4' cols='50'></textarea>"
            str += "<br><button class='rplyButton' value=" + msgId + " onclick='submitReply(value)'>Reply to Comment</button>"
            $("#commentPH").append(str);
        }
        function printMessages(msgArr, id) {
            for (let i = 0; i < msgArr.length; i++) {
                let msgId = "" + id + "_" + (i + 1);
                msg = msgArr[i];
                str = "<div id='" + msgId + "'>"
                str += "<div class='pComment container'><div class='row'>"
                str += "<div class='col-1'>" + (i + 1) + ".</div>";
                str += "<div class='col-10'><div class='fromUser'>User: " + msg.user + "</div><div class='message'> Message: " + msg.content + "</div></div>"
                str += "<div class='col-1'><button class='rplyButton' value='" + msgId + "'onclick='showTA(value)'>Reply</button></div>";
                str += "</div></div>";
                str += "<div class='replyTA' id='" + msgId + "_DIV'><textarea id='" + msgId + "_TA' class='TA' name='replyTA' rows='4' cols='50'></textarea>"
                str += "<br><button class='rplyButton' value=" + msgId + " onclick='submitReply(value)'>Reply to Comment</button>"
                $("#commentPH").append(str);
            }
        }
        function createRplyList(id) {
            for (let i = 0; i < msgArr[id].length; i++) {
                tmpRplyArr = [];
                let t = "" + id + "_" + (i + 1);
                render_replies(t, tmpRplyArr);
                rplyArr[t] = tmpRplyArr;
            }
        }
        function render_replies(id, tmpRplyArr) {
            let i = 0;
            console.log(id);
            ref = firebase.database().ref("/replies/" + id);
            ref.on("child_added", snapshot => {
                msg = {
                    user: snapshot.val().user,
                    content: snapshot.val().msg,
                }
                tmpRplyArr.push(msg)
                printReply(msg, id, ++i);
            })

        }
        function printReply(msg, id, i) {
            let cId = id.split("_");
            let str = "<div class='sComment container'><div class='row'>"
            str += "<div class='col-1'>" + cId[1] + "." + i + "</div>";
            str += "<div class='col-10'><div class='fromUser'>User: " + msg.user + "</div><div class='message'> Message: " + msg.content + "</div></div>";
            str += "</div></div>";
            $("#" + id).append(str);
            
        }
        function showTA(msgId) {
            let ta = "#" + msgId + "_DIV";
            if ($(ta).css('display') == 'none')
                $(ta).css('display', 'block');
            else $(ta).css('display', 'none')
        }
        function submitReply(msgId) {
            if (localStorage.user == null)
                alert("Please log in before posting a comment")
            else {
                let ta = "#" + msgId + "_TA";
                msg = $(ta).val();
                if (msg == "")
                    alert("Please enter a comment")
                else {
                    ref = firebase.database().ref("/replies/" + msgId);
                    user = JSON.parse(localStorage.user);
                    ref.push().set({ "msg": msg, "user": user.Fname, });
                }
                let div = ta = "#" + msgId + "_DIV";
                $(div).css('display', 'none');
            }
        }

        function select_episode(id) {
            if (localStorage.user == undefined) {
                alert("Please log in before adding an episode");
                return;
            }
            let storedUser = JSON.parse(localStorage.user);
            season = episodes[id].season_number;
            episode = episodes[id];
            series = addSeries();

            let ep = {
                EpisodeID: episode.id,
                SeriesID: series.Id,
                SeriesName: series.Name,
                SeasonNum: episode.season_number,
                EpisodeName: episode.name,
                EpisodeImg: imagePath + episode.still_path,
                EpisodeOverview: episode.overview,
                EpisodeAirdate: episode.air_date
            }
            let obj = {
                S: series,
                E: ep,
                U: storedUser.UserId
            }
            console.log(obj);


            let api = "../api/Objects";
            ajaxCall("POST", api, JSON.stringify(obj), postEpisodeSuccessCB, postEpisodeErrorCB)

            addGenre(storedUser);

            return false;
        }
        function postEpisodeSuccessCB(postEp) {
            alert("Added episode to the server")
        }
        function postEpisodeErrorCB(err) {
            console.log(err)
        }


        function addSeries() {
            let selectedSeries = {
                Id: sTmp.id,
                First_air_date: sTmp.first_air_date,
                Name: sTmp.name,
                Origin_country: sTmp.origin_country[0],
                Original_language: sTmp.original_language,
                Overview: sTmp.overview,
                Popularity: sTmp.popularity,
                Poster_path: imagePath + sTmp.poster_path
            };

            return selectedSeries;
        }
        function addGenre(user) {
            let genres = [];
            for (let i = 0; i < sTmp.genres.length; i++) {
                genres.push(sTmp.genres[i].name);
            }
            let genre = {
                UserId: user.UserId,
                SeriesId: sTmp.id,
                Genres: genres
            }
            let api = "../api/Genres";
            ajaxCall("POST", api, JSON.stringify(genre), postGenresSuccessCB, postGenresErrorCB)
        }
        function postGenresSuccessCB(g) {

        }
        function postGenresErrorCB(err) {
            console.log(err);
        }
        function postSeriesSuccessCB(s) {
            console.log("Added series to the database");
        }
        function postSeriesErrorCB(err) {
            console.log(err);
        }
        function getSeasonErrorCB(err) {
            console.log(err);
        }
        function getTVErrorCB(err) {
            console.log(err);
        }
        function checkPassword() {
            pattern = /^(?=.*[0-9])(?=.*[A-Z]).{6,}$/g;
            password = this.value;

            if (pattern.test(password)) {
                this.validity.valid = true;
                this.setCustomValidity('');
            }
            else {
                this.validity.valid = false;
                this.setCustomValidity('Password must contain 6 characters, at least one digit and at least one upper case letter');
            }
        }
        function submitUser() {
            addUser();

            return false;
        }
        function addUser() {
            let user = {
                Fname: $("#fname").val(),
                Lname: $("#lname").val(),
                Email: $("#email").val(),
                Password: $("#password").val(),
                Pnumber: $("#phone").val(),
                Gender: $("#gender").val(),
                BirthYear: $("#birthYear").val(),
                PGenre: $("#genre").val(),
                Address: $("#address").val()
            };
            console.log(user);

            let api = "../api/Users";
            ajaxCall("POST", api, JSON.stringify(user), postUserSuccessCB, postUserErrorCB)
        }
        function postUserSuccessCB() {
            alert("Registeration Completed Successfully! Please Log in");
            document.getElementById("rForm").reset();
            showLogin();
        }
        function postUserErrorCB(err) {
            console.log(err);
        }
        function submitLogin() {
            loginUser();

            return false;
        }
        function resumeUser() {
            user = JSON.parse(localStorage.user);
            document.getElementById("modalLogin").style.display = "none"
            $("#welcome").html("Welcome, " + user.Fname);
            $("#register").hide();
            $("#login").hide();
            $("#signout").show();
            if (user.IsAdmin)
                $("#adminPanel").show();
            getUserRating(user.UserId);

            let api = "../api/Genres?user=" + user.UserId
            ajaxCall("GET", api, "", getRecommendedSuccessCB, getRecommendedErrorCB)
        }
        async function getRecommendedSuccessCB(recList) {
            if (recList == null) {
                p = getPopularSeries();
            }
            else {
                recList.reverse();
                console.log(recList);
                let method = "3/tv/";
                let api_key = "?api_key=" + key;

                for (let i = 0; i < recList.length; i++) {
                    let apiCall = url + method + recList[i].SeriesId + api_key;
                    ajaxCall("GET", apiCall, "", getRecTvSuccessCB, getRecTvErrorCB);
                    await sleep(500);
                    if (i == 6)
                        break;
                }
                for (let i = 0; i < recList.length; i++) {
                    $("#" + recList[i].SeriesId + "_score").append(recList[i].Score);
                    if (i == 6)
                        break;
                }
                $("#recTitle").html("Don't Know What to Watch? Try the Recommended Shows!<br>Higher score, Higher suitablility!")
                $("#recPH").css('display', 'block');
            }
        }
        function getRecommendedErrorCB(err) {
            console.log(err);
        }
        function getRecTvSuccessCB(series) {
            console.log(series);

            let str = "<div class='card recCard' id='" + series.id + "' onclick='renderRecTv(this.id)'>";
            str += "<img src='" + imagePath + series.poster_path + "'>";
            str += "<div class='seasonInfo'><h5><b>" + series.name + "</b></h4><p id='" + series.id + "_score' >Score: " + "</div>";
            str += "</div>";
            $("#recRowPH").append(str);
        }
        function getRecTvErrorCB(err) {
            console.log(err);
        }
        function renderRecTv(id) {
            let method = "3/tv/";
            let api_key = "?api_key=" + key;
            let apiCall = url + method + id + api_key;
            ajaxCall("GET", apiCall, "", getTVSuccessCB_2, getTVErrorCB_2);
        }
        function getTVSuccessCB_2(series) {
            let poster = imagePath + series.poster_path;
            let str = "";
            tvId = series.id;
            str += "<div class='TvTitle'>" + series.name + " (" + series.first_air_date.slice(0, 4) + ")</div>";
            str += "<div class='row' id='seriesRowPH'>";
            str += "<div class='col-3' id='leftDiv'>";
            str += "<img src='" + poster + "'/>";
            str += "</div>";
            str += "<div class='col-9' id='rightDiv'>";
            str += "<p>" + series.overview + "</p>";
            str += "<div id='genrePH'><span class='bold'> Genres:</span> </div>";
            str += "</div>";
            $("#seriesPH").html(str);
            $("#seriesPH").css('display', 'block')
            $("#episodes1").html("");
            let method = "3/tv/";
            let api_key = "api_key=" + key
            //      let apiCall = url + method + tvId + "/season/" + 0 + "?" + api_key
            let apiCall = url + method + series.id + "?" + api_key

            ajaxCall("GET", apiCall, "", getSeriesSuccessCB, getSeasonErrorCB)

            //Get cast info
            let apiCall_2 = url + method + series.id + "/credits?" + api_key
            ajaxCall("GET", apiCall_2, "", getCreditsSuccessCB, getCreditsErrorCB);
            let apiCall_3 = url + method + series.id + "/videos?" + api_key
            ajaxCall("GET", apiCall_3, "", getTrailerSuccessCB, getTrailerErrorCB);
        }
        function getTVErrorCB_2(err) {
            console.log(err);
        }
        function getPopularSeries() {
            let method = "3/tv/popular";
            let api_key = "?api_key=" + key;
            let apiCall = url + method + api_key;
            ajaxCall("GET", apiCall, "", getPopularTVSuccessCB, getPopularTVErrorCB);
        }
        function getPopularTVSuccessCB(popular) {
            console.log(popular);
            popular = popular.results;
            for (let i = 0; i < 6; i++) {
                let str = "<div class='card recCard' id='" + popular[i].id + "' onclick='renderRecTv(this.id)'>";
                str += "<img src='" + imagePath + popular[i].poster_path + "'>";
                str += "<div class='seasonInfo'><h5><b>" + popular[i].name + "</b></h4><p>Popularity: " + popular[i].popularity +  "</div>";
                str += "</div>";
                $("#recRowPH").append(str);
            }
            $("#recTitle").html("Log in and add your favorite episodes so we can recommend new shows for you!<br>For now, here's a list of popular shows:")
            $("#recPH").css("display", "block");
        }
        function getPopularTVErrorCB(err) {
            console.log(err);
        }
        function loginUser() {
            let email = $("#loginEmail").val();
            let password = $("#loginPassword").val()
            let api = "../api/Users?email=" + email + "&password=" + password;
            ajaxCall("GET", api, "", getUserSuccessCB, getUserErrorCB)
        }
        function getUserSuccessCB(user) {
            console.log(user)
            alert("Logged in Successfully!")
            user.Password = "";
            localStorage.user = JSON.stringify(user);
            document.getElementById("modalLogin").style.display = "none"
            $("#welcome").html("Welcome, " + user.Fname);
            $("#register").hide();
            $("#login").hide();
            $("#signout").show();
            if (user.IsAdmin)
                $("#adminPanel").show();
            document.getElementById("lForm").reset();
            getUserRating(user.UserId);
        }
        function getUserErrorCB(err) {
            alert("Incorrect Email or Password");
        }
        function signOut() {
            alert("Signed out Successfully");
            localStorage.clear();
            $("#welcome").html("Welcome");
            $("#register").show();
            $("#login").show();
            $("#signout").hide();
            $("#adminPanel").hide();
        }
        function showRegister() {
            document.getElementById("modalLogin").style.display = "none"
            document.getElementById("modalRegister").style.display = "block"
        }
        function showLogin() {
            document.getElementById("modalRegister").style.display = "none"
            document.getElementById("modalLogin").style.display = "block"
        }
        function viewEpisodes() {
            if (localStorage.user == undefined)
                alert("Please log in before viewing selected episodes")
            else document.location = 'view.html';
        }
        function showAdmin() {
            document.location = 'adminPanel.html';
        }
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        window.onclick = function (event) {
            let ml = document.getElementById("modalLogin");
            let mr = document.getElementById("modalRegister");
            if (event.target == ml)
                ml.style.display = "none";
            else if (event.target == mr)
                mr.style.display = "none";
            document.getElementById("modalActor").style.display = "none";

            let md = document.getElementById("modalDiscussion");
            if (event.target == md)
                md.style.display = "none";
        }


        //https://api.themoviedb.org/3/tv/{tv_id}/season/{season_number}?api_key=<<api_key>>&language=en-US
    </script>
</head>
    <body class="mainBG">
        <div class="container">
            <h1 class="title" id="welcome">Welcome</h1>

            <button id="login" onclick="showLogin()">Login</button>
            <button id="register" onclick="showRegister()">Register</button>
            <button id="signout" onclick="signOut()">Sign Out</button>
            <button id="adminPanel" onclick="showAdmin()">Admin Panel</button>
            <br />

            <div class="container modal" id="modalLogin">
                <div class="modal-content">
                    <form id="lForm">
                        <h2 style="text-align:center">Please enter your Email and Password</h2>
                        <div class="form-group">
                            <label for="loginEmail">Email</label>
                            <input type="text" class="form-control" id="loginEmail" placeholder="Enter User's Email" required />
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">Password</label>
                            <input type="password" class="form-control" id="loginPassword" placeholder="Enter User's Password" required />
                        </div>

                        <input type="submit" value="Login" />
                        <input type="button" onclick="showRegister()" value="New User? Register Here!" />

                    </form>
                </div>
            </div>


            <div class="container modal" id="modalRegister">
                <div class="modal-content">
                    <form id="rForm">
                        <h2 style="text-align:center">Please enter User info</h2>
                        <div class="form-group">
                            <label for="fname">First Name</label>
                            <input type="text" class="form-control" id="fname" placeholder="Enter User's First Name" required />
                        </div>
                        <div class="form-group">
                            <label for="lname">Last Name</label>
                            <input type="text" class="form-control" id="lname" placeholder="Enter User's Last Name" required />
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" class="form-control" id="email" placeholder="Enter User's Email" required />
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" class="form-control" id="password" placeholder="Enter User's Password" required />
                        </div>
                        <div class="form-group">
                            <label for="phone">Cellphone Number</label>
                            <input type="tel" class="form-control" id="phone" placeholder="Enter User's Cellphone Number 0dd-ddddddd" required
                                   pattern="[0][0-9]{2}-[0-9]{7}"
                                   oninvalid="this.setCustomValidity('Format should be 0dd-ddddddd')"
                                   oninput="this.setCustomValidity('')" />
                        </div>
                        <div class="form-group">
                            <label for="gender">Gender</label>
                            <select id="gender" required>
                                <option disabled selected> Select Gender </option>
                                <option value="m">Male</option>
                                <option value="f">Female</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="birthYear">Year of Birth</label>
                            <select id="birthYear" required></select>
                        </div>
                        <div class="form-group">
                            <label for="genre">Preferred Genre</label>
                            <input type="text" class="form-control" id="genre" placeholder="Enter User's Preferred Genre (Optional)" />
                        </div>
                        <div class="form-group">
                            <label for="address">Address</label>
                            <input type="text" class="form-control" id="address" placeholder="Enter User's Address" required />
                        </div>

                        <input type="submit" value="Register" />
                        <input type="button" onclick="showLogin()" value="Already a User? Login Here!" />
                    </form>
                </div>
            </div>

            <div id="searchDiv">
                <input type="text" id="tvShowName" />
                <button id="getTV">Get TV Show</button>
                <button onclick="viewEpisodes()">View Selected Episodes</button>
            </div>
            <div class="container" id="recPH">
                <div id="recTitle" class="title"></div>
                <div class="row" id="recRowPH"></div>
            </div>
            <div class="container" id="seriesPH"></div>
            <div id="trailerPH"></div>
            <div class="container" id="castPH"></div>

            <div class="container modal" id="modalActor">
                <div class='modal-content' id="contentActor">

                </div>
            </div>
            <div class="container modal" id="modalDiscussion">
                <div class='modal-content' id="contentDiscussion">

                </div>
            </div>
            <div id="seasons"> </div>
            <div id="seasons1"></div>

            <div id="episodes"> </div>
            <div id="episodes1"></div>
        </div>

</body>
</html>